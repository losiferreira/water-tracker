name: Build APK (No Signing)

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v1.1.0, etc.
  workflow_dispatch:  # Allows manual trigger from GitHub Actions tab

permissions:
  contents: write
  
jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Make gradlew executable
      run: chmod +x gradlew
      
    - name: Build Release APK
      run: ./gradlew assembleRelease --no-daemon
      
    - name: Build Debug APK
      run: ./gradlew assembleDebug --no-daemon
        
    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="manual-$(date +'%Y%m%d-%H%M%S')"
        else
          VERSION="${{ github.ref_name }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: Rename APKs
      run: |
        cd app/build/outputs/apk/release
        mv app-release-unsigned.apk WaterTracker-${{ steps.version.outputs.version }}-release.apk
        cd ../debug
        mv app-debug.apk WaterTracker-${{ steps.version.outputs.version }}-debug.apk
        
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: WaterTracker ${{ steps.version.outputs.version }}
        body: |
          ## WaterTracker Android App - ${{ steps.version.outputs.version }}
          
          ### Features
          - Water intake tracking with progress visualization
          - History screen showing past daily intake
          - Customizable daily water intake goals
          - Floating bubble overlay for quick water logging
          - Real-time updates between screens
          - Material 3 dark theme
          
          ### Download Options
          - **Release APK**: Optimized production build (recommended)
          - **Debug APK**: Development build with debugging enabled
          
          ### Installation Instructions
          1. Download the Release APK from the assets below
          2. Enable "Install from unknown sources" in Android Settings â†’ Security
          3. Install the downloaded APK file
          4. Grant overlay permission when prompted (needed for floating bubble)
          
          ### System Requirements
          - Android 7.0 (API 24) or higher
          - Overlay permission for floating bubble feature
          - ~10MB free space
          
          ### Architecture
          - Frontend: Jetpack Compose with Material 3
          - Database: Room with RxJava3 reactive streams
          - Pattern: MVVM with Clean Architecture
          - DI: Koin dependency injection
          
          Found an issue? [Report it here](https://github.com/losiferreira/water-tracker/issues)
        files: |
          app/build/outputs/apk/release/WaterTracker-${{ steps.version.outputs.version }}-release.apk
          app/build/outputs/apk/debug/WaterTracker-${{ steps.version.outputs.version }}-debug.apk
        draft: false
        prerelease: false
